# ACL（アクセス制御リスト）設定ガイド

このガイドでは、JumboDogXのACL（Access Control List）機能を使用して、サーバーへのアクセスを制御する方法を説明します。

## ACLとは？

ACL（Access Control List）は、特定のIPアドレスやIPアドレス範囲からのアクセスを許可または拒否する機能です。

### ACLが設定できるサーバー

JumboDogXでは、以下のサーバーでACLを設定できます：

- **HTTP/HTTPS サーバー** - Virtual Host単位でアクセス制御
- **DNS サーバー** - DNS問い合わせのアクセス制御
- **POP3 サーバー** - メール受信のアクセス制御
- **FTP サーバー** - ファイル転送のアクセス制御
- **TFTP サーバー** - TFTPアクセス制御
- **DHCP サーバー** - MACアドレスベースのアクセス制御（特殊）

**注意**: SMTP サーバーとProxy サーバーには、現在ACL機能がありません。

## ACLの動作モード

JumboDogXのACLには、2つの動作モードがあります。

### Allow Mode（Allowlist / ホワイトリスト）

- **デフォルトの動作**: すべて拒否
- **リストの役割**: リストに登録されたIPアドレスのみ許可
- **用途**: 特定のIPアドレスのみアクセスを許可したい場合

**例**: 社内ネットワーク（192.168.1.0/24）からのみアクセスを許可

### Deny Mode（Denylist / ブラックリスト）

- **デフォルトの動作**: すべて許可
- **リストの役割**: リストに登録されたIPアドレスのみ拒否
- **用途**: 特定のIPアドレスからのアクセスを拒否したい場合

**例**: 攻撃元IPアドレス（203.0.113.50）をブロック

### モードの選択

| 目的 | 推奨モード |
|------|-----------|
| ローカルネットワークのみアクセス許可 | Allow Mode |
| 特定のIPアドレスをブロック | Deny Mode |
| 厳格なアクセス制御 | Allow Mode |
| 基本的にオープン、一部をブロック | Deny Mode |

**セキュリティのヒント**: より厳格なセキュリティが必要な場合は、Allow Modeを使用してください。

## 基本設定

### ステップ1: ACL設定画面を開く

ACLの設定は、各サーバーのSettings画面から行います。

#### HTTP/HTTPS サーバーの場合

1. サイドメニューから **Settings** をクリック
2. **HTTP/HTTPS** セクションを展開
3. 設定したい仮想ホスト（例：`sample.com`）を展開
4. **ACL** をクリック

![HTTP ACL設定画面](images/http-acl-menu.png)
*HTTP/HTTPS サーバーのACL設定画面*

#### DNS サーバーの場合

1. サイドメニューから **Settings** をクリック
2. **DNS** セクションを展開
3. **ACL** をクリック

#### その他のサーバー

各サーバーのSettingsセクション内に**ACL**メニューがあります：
- Settings > **POP3** > ACL
- Settings > **FTP** > ACL
- Settings > **TFTP** > ACL
- Settings > **DHCP** > ACL（MAC address形式）

### ステップ2: ACL Modeの選択

1. **Access Control Mode** ドロップダウンから選択：
   - **Allow Mode (Allowlist)** - ホワイトリスト方式
   - **Deny Mode (Denylist)** - ブラックリスト方式

2. **Save Settings** ボタンをクリック

![ACL Mode選択](images/acl-mode-selection.png)
*ACL Modeの選択*

### ステップ3: ACLエントリの追加

1. **Add ACL Entry** ボタンをクリック
2. 新しいエントリが追加されます
3. 以下の項目を入力：
   - **Name**: エントリの名前（例：`Localhost`, `Office Network`）
   - **IP Address / Range**: IPアドレスまたは範囲
4. **Save Settings** ボタンをクリック

![ACLエントリ追加](images/acl-entry-add.png)
*ACLエントリの追加*

## IPアドレス形式

JumboDogXのACLは、以下の形式をサポートしています。

### 1. 単一IPアドレス

特定のIPアドレス1つを指定します。

**例**:
```
192.168.1.100
127.0.0.1
203.0.113.50
```

**用途**: 特定のコンピューターのみ許可/拒否

### 2. CIDR表記（推奨）

ネットワークアドレスをCIDR形式で指定します。

**例**:
```
192.168.1.0/24    # 192.168.1.0 - 192.168.1.255
10.0.0.0/8        # 10.0.0.0 - 10.255.255.255
192.168.1.0/28    # 192.168.1.0 - 192.168.1.15
```

**用途**: ネットワーク全体を許可/拒否

#### よく使うCIDR範囲

| CIDR | アドレス範囲 | ホスト数 |
|------|------------|---------|
| /32 | 1つのIPアドレス | 1 |
| /30 | 4つのIPアドレス | 4 |
| /28 | 16個のIPアドレス | 16 |
| /24 | 256個のIPアドレス | 256 |
| /16 | 65,536個のIPアドレス | 65,536 |
| /8 | 16,777,216個のIPアドレス | 16,777,216 |

### 3. IPレンジ（開始-終了）

開始IPアドレスと終了IPアドレスで範囲を指定します。

**例**:
```
192.168.1.1-192.168.1.254
10.0.0.100-10.0.0.200
```

**用途**: 連続しないネットワーク範囲を指定

### 4. ワイルドカード

アスタリスク（`*`）を使用して範囲を指定します。

**例**:
```
192.168.1.*       # 192.168.1.0 - 192.168.1.255
192.168.*.*       # 192.168.0.0 - 192.168.255.255
10.*.*.*          # 10.0.0.0 - 10.255.255.255
```

**用途**: 簡易的にネットワーク範囲を指定（CIDR推奨）

### 形式の選び方

| 目的 | 推奨形式 | 例 |
|------|---------|---|
| 特定のPC | 単一IP | `192.168.1.100` |
| ネットワーク全体 | CIDR | `192.168.1.0/24` |
| 不規則な範囲 | IPレンジ | `192.168.1.10-192.168.1.50` |
| 簡易指定 | ワイルドカード | `192.168.1.*` |

**推奨**: 明確で標準的な**CIDR表記**を使用することを推奨します。

## 設定例

### 例1: localhostのみ許可（開発環境）

**シナリオ**: ローカルマシンからのみアクセスを許可

**設定**:
1. **Access Control Mode**: Allow Mode
2. **ACLエントリ**:
   - Name: `Localhost`
   - IP Address: `127.0.0.1`

![Localhost設定](images/acl-localhost-only.png)
*localhostのみ許可する設定*

### 例2: 社内ネットワークからのアクセス許可

**シナリオ**: 社内ネットワーク（192.168.1.0/24）からのみアクセスを許可

**設定**:
1. **Access Control Mode**: Allow Mode
2. **ACLエントリ**:
   - Name: `Office Network`
   - IP Address: `192.168.1.0/24`

### 例3: 複数のネットワークを許可

**シナリオ**: 複数の拠点からアクセスを許可

**設定**:
1. **Access Control Mode**: Allow Mode
2. **ACLエントリ**:
   - Name: `Tokyo Office`
   - IP Address: `192.168.1.0/24`

   - Name: `Osaka Office`
   - IP Address: `192.168.2.0/24`

   - Name: `VPN Users`
   - IP Address: `10.0.0.0/24`

![複数ネットワーク設定](images/acl-multiple-networks.png)
*複数のネットワークを許可する設定*

### 例4: 特定のIPアドレスをブロック

**シナリオ**: 攻撃元IPアドレスをブロック

**設定**:
1. **Access Control Mode**: Deny Mode
2. **ACLエントリ**:
   - Name: `Blocked Attacker`
   - IP Address: `203.0.113.50`

   - Name: `Spam Network`
   - IP Address: `198.51.100.0/24`

### 例5: 開発者のみアクセス許可

**シナリオ**: 特定の開発者のIPアドレスのみ許可

**設定**:
1. **Access Control Mode**: Allow Mode
2. **ACLエントリ**:
   - Name: `Developer 1`
   - IP Address: `192.168.1.100`

   - Name: `Developer 2`
   - IP Address: `192.168.1.101`

   - Name: `localhost`
   - IP Address: `127.0.0.1`

## DHCP サーバーのACL（MACアドレスベース）

DHCP サーバーのACLは、他のサーバーと異なり、**MACアドレスベース**で動作します。

### MACアドレスの形式

以下の形式がサポートされています：

```
00:11:22:33:44:55       # コロン区切り（推奨）
00-11-22-33-44-55       # ハイフン区切り
001122334455            # 区切りなし
```

### DHCP ACL設定例

#### 特定のデバイスにのみIPアドレスを割り当てる

**設定**:
1. **Access Control Mode**: Allow Mode
2. **ACLエントリ**:
   - Name: `Office PC 1`
   - MAC Address: `00:11:22:33:44:55`

   - Name: `Office PC 2`
   - MAC Address: `00:11:22:33:44:66`

#### 特定のデバイスをブロック

**設定**:
1. **Access Control Mode**: Deny Mode
2. **ACLエントリ**:
   - Name: `Unauthorized Device`
   - MAC Address: `00:11:22:AA:BB:CC`

![DHCP ACL設定](images/dhcp-acl-mac.png)
*DHCP サーバーのMACアドレスベースACL*

## AttackDb連携（自動ACL追加）

JumboDogXは、攻撃検出システム（AttackDb）と連携して、自動的にACLエントリを追加する機能があります。

### 動作の仕組み

1. **攻撃検出**: サーバーが不審なアクセスを検出
2. **AttackDbに記録**: 攻撃元IPアドレスを記録
3. **自動ACL追加**: 一定の条件を満たすと、自動的にACLに追加してブロック

### 対応サーバー

現在、以下のサーバーで自動ACL追加機能が有効です：

- **HTTP/HTTPS サーバー** - Apache Killer攻撃などを検出

### 自動追加されたエントリの確認

自動追加されたACLエントリは、ACL設定画面で確認できます：

- Name: `Auto-blocked: <IPアドレス>` のように表示されます
- 手動で削除することも可能です

![自動ACL追加](images/acl-auto-blocked.png)
*AttackDbにより自動追加されたACLエントリ*

## よくある問題と解決方法

### 自分自身がブロックされた

**症状**: Allow Modeで設定保存後、自分自身もアクセスできなくなった

**原因**: 自分のIPアドレスがACLに登録されていない

**解決策**:

**方法1**: 設定ファイルから修正（推奨）

1. JumboDogXを停止
2. `appsettings.json` を直接編集
3. ACL設定を修正または削除
4. JumboDogXを再起動

**方法2**: コマンドラインから起動時にACLを無効化

```bash
# 環境変数でACLを無効化（一時的）
export JDX_DISABLE_ACL=true
dotnet run --project src/Jdx.WebUI
```

**防止策**: Allow Modeを使用する場合は、**必ず自分のIPアドレスを追加してから保存**してください。

### localhostからアクセスできない

**症状**: `127.0.0.1` を追加したのにlocalhostからアクセスできない

**原因**: IPv6アドレス（::1）でアクセスしている可能性

**解決策**: IPv6のlocalhostアドレスも追加

```
127.0.0.1    # IPv4 localhost
::1          # IPv6 localhost
```

### ACLが反映されない

**症状**: ACLエントリを追加しても、アクセス制御が機能しない

**確認事項**:
1. **Save Settings** ボタンをクリックしたか確認
2. 成功メッセージが表示されたか確認
3. 正しいIPアドレス形式を使用しているか確認
4. ブラウザのキャッシュをクリアして再試行

### ワイルドカードが機能しない

**症状**: `192.168.*.*` が期待通りに動作しない

**原因**: 一部のサーバーでワイルドカードがサポートされていない可能性

**解決策**: CIDR表記を使用

```
192.168.0.0/16    # 192.168.*.* と同等
```

### DHCPでMACアドレスフィルタリングが効かない

**症状**: DHCP ACLでMACアドレスを設定したのに、IPアドレスが割り当てられる

**確認事項**:
1. MACアドレスの形式が正しいか確認
2. ACL Modeが正しく設定されているか確認（Allow/Deny）
3. MACアドレスの大文字/小文字を確認（一部環境では区別される）

## セキュリティのベストプラクティス

### 1. 最小権限の原則

必要最小限のアクセスのみ許可してください。

**良い例**:
```
Allow Mode:
- 127.0.0.1 (localhost)
- 192.168.1.0/24 (社内ネットワーク)
```

**悪い例**:
```
Allow Mode:
- 0.0.0.0/0 (全世界に公開)  # これでは意味がない
```

### 2. Deny Modeの使用は慎重に

Deny Modeは、デフォルトで全てを許可するため、未知の脅威に対して脆弱です。

- ローカル開発環境や限定的な用途では問題ありません
- 本番環境では**Allow Mode**を推奨

### 3. 定期的なACLの見直し

- 不要になったIPアドレスは削除
- 新しいオフィスや拠点が追加された場合は更新
- 退職者のIPアドレスは削除

### 4. ログの監視

ACLによってブロックされたアクセスは、ログに記録されます。

```bash
# ログでブロックされたアクセスを確認
cat logs/jumbodogx-*.log | grep "Access denied"
```

### 5. AttackDb自動ACL追加の活用

HTTP/HTTPSサーバーでは、AttackDbによる自動ACL追加機能を活用して、攻撃を自動的にブロックできます。

## まとめ

このガイドでは、以下の内容を学びました：

✓ ACLの基本概念（Allow Mode vs Deny Mode）
✓ ACL設定画面の使い方
✓ IPアドレス形式とその選び方
✓ 実用的な設定例
✓ DHCP サーバーのMACアドレスベースACL
✓ AttackDb連携による自動ACL追加
✓ トラブルシューティング
✓ セキュリティのベストプラクティス

ACLを適切に設定することで、JumboDogXサーバーへのアクセスを効果的に制御し、セキュリティを向上させることができます。

## 関連ドキュメント

- [HTTPサーバー クイックスタート](../http/getting-started.md) - HTTP ACL設定の詳細
- [セキュリティベストプラクティス](security-best-practices.md) - 総合的なセキュリティ対策
- [ロギングガイド](logging.md) - ACL関連ログの確認方法
