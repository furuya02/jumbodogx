# DHCPサーバー - IPプール設定

JumboDogXのDHCPサーバーにおけるIPアドレスプールの詳細設定について説明します。

## IPプールとは

IPプール（IPアドレスプール）は、DHCPサーバーがクライアントに割り当て可能なIPアドレスの範囲です。クライアントがネットワークに接続すると、このプールから自動的にIPアドレスが割り当てられます。

## 基本的なIPプール設定

### 設定例

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.200",
    "LeaseTime": 86400,
    "DnsServers": ["8.8.8.8", "8.8.4.4"],
    "Gateway": "192.168.1.1"
  }
}
```

**設定項目**:
- **BindAddress**: DHCPサーバーのIPアドレス（自身のIPアドレス）
- **SubnetMask**: サブネットマスク
- **StartIp**: IPプールの開始アドレス
- **EndIp**: IPプールの終了アドレス
- **LeaseTime**: IPアドレスのリース時間（秒）
- **DnsServers**: クライアントに配布するDNSサーバーのリスト
- **Gateway**: デフォルトゲートウェイ（ルーター）のIPアドレス

---

## IPアドレス範囲の計算

### サブネットマスクとIPアドレス範囲

サブネットマスクによって、使用可能なIPアドレスの範囲が決まります。

**例: 192.168.1.0/24 (サブネットマスク: 255.255.255.0)**:
- ネットワークアドレス: `192.168.1.0`
- ブロードキャストアドレス: `192.168.1.255`
- 使用可能なIPアドレス: `192.168.1.1` - `192.168.1.254` (254個)

**推奨設定**:
- DHCPサーバー自身: `192.168.1.1`
- IPプール: `192.168.1.100` - `192.168.1.200` (101個)
- 静的IP用予備: `192.168.1.2` - `192.168.1.99` (98個)

---

### サブネットマスクの種類

| CIDR | サブネットマスク | 使用可能IP数 | 用途 |
|------|------------------|--------------|------|
| /24 | 255.255.255.0 | 254 | 一般的な家庭・小規模オフィス |
| /25 | 255.255.255.128 | 126 | 小規模ネットワーク |
| /26 | 255.255.255.192 | 62 | 非常に小規模ネットワーク |
| /23 | 255.255.254.0 | 510 | 中規模ネットワーク |
| /22 | 255.255.252.0 | 1022 | 大規模ネットワーク |

**例: /25 (255.255.255.128) の設定**:
```json
{
  "DhcpServer": {
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.128",
    "StartIp": "192.168.1.10",
    "EndIp": "192.168.1.126",
    "Gateway": "192.168.1.1"
  }
}
```

---

## リース時間の設定

### リース時間とは

リース時間は、クライアントに割り当てられたIPアドレスの有効期限です。リース時間が経過すると、クライアントは更新（renew）を試みます。

### リース時間の推奨値

| 環境 | リース時間 | 秒数 | 説明 |
|------|-----------|------|------|
| 開発環境 | 1時間 | 3600 | 頻繁な変更に対応 |
| 一般的なオフィス | 8時間 | 28800 | 営業時間内で更新 |
| 標準設定 | 24時間 | 86400 | 最も一般的 |
| 安定した環境 | 1週間 | 604800 | あまり変更がない環境 |

### リース時間の設定例

**短いリース時間（開発環境）**:
```json
{
  "DhcpServer": {
    "LeaseTime": 3600  # 1時間
  }
}
```

**長いリース時間（安定した環境）**:
```json
{
  "DhcpServer": {
    "LeaseTime": 604800  # 1週間
  }
}
```

---

## DNSサーバーの設定

### 複数のDNSサーバー

クライアントには、複数のDNSサーバーを配布できます。最初のサーバーが応答しない場合、次のサーバーが使用されます。

```json
{
  "DhcpServer": {
    "DnsServers": [
      "8.8.8.8",      # Google DNS (プライマリ)
      "8.8.4.4",      # Google DNS (セカンダリ)
      "1.1.1.1"       # Cloudflare DNS (ターシャリ)
    ]
  }
}
```

### よく使われるパブリックDNS

| サービス | プライマリ | セカンダリ |
|----------|-----------|-----------|
| Google DNS | 8.8.8.8 | 8.8.4.4 |
| Cloudflare DNS | 1.1.1.1 | 1.0.0.1 |
| OpenDNS | 208.67.222.222 | 208.67.220.220 |
| Quad9 | 9.9.9.9 | 149.112.112.112 |

### ローカルDNSサーバーの使用

JumboDogXのDNSサーバーを使用する場合:
```json
{
  "DhcpServer": {
    "DnsServers": [
      "192.168.1.1",  # JumboDogXのDNSサーバー
      "8.8.8.8"       # フォールバック用
    ]
  }
}
```

---

## デフォルトゲートウェイの設定

### ゲートウェイとは

デフォルトゲートウェイは、クライアントがローカルネットワーク外と通信する際に使用するルーターのIPアドレスです。

### 設定例

**ルーターがある環境**:
```json
{
  "DhcpServer": {
    "Gateway": "192.168.1.1"  # ルーターのIPアドレス
  }
}
```

**ルーターがない環境（隔離されたネットワーク）**:
```json
{
  "DhcpServer": {
    "Gateway": null  # ゲートウェイなし
  }
}
```

---

## 静的IP割り当て

### 静的IPとは

静的IP割り当ては、特定のMACアドレスに対して固定のIPアドレスを割り当てる機能です。

### 設定例

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.200",
    "LeaseTime": 86400,
    "DnsServers": ["192.168.1.1"],
    "Gateway": "192.168.1.1",
    "StaticLeases": [
      {
        "MacAddress": "00:11:22:33:44:55",
        "IpAddress": "192.168.1.50"
      },
      {
        "MacAddress": "AA:BB:CC:DD:EE:FF",
        "IpAddress": "192.168.1.51"
      }
    ]
  }
}
```

**注意**: 静的IPアドレスは、IPプールの範囲外に設定することを推奨します。

---

## IPアドレスの競合回避

### 推奨設定

IPアドレスの競合を避けるため、以下のように範囲を分けることを推奨します：

```
192.168.1.0/24 ネットワーク:
├── 192.168.1.1        : DHCPサーバー自身
├── 192.168.1.2-99     : 静的IP用予備（サーバー、プリンター等）
├── 192.168.1.100-200  : DHCPプール（動的割り当て）
└── 192.168.1.201-254  : 予備（将来の拡張用）
```

**設定例**:
```json
{
  "DhcpServer": {
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.200",
    "StaticLeases": [
      {
        "MacAddress": "00:11:22:33:44:55",
        "IpAddress": "192.168.1.10"  # プール外の静的IP
      }
    ]
  }
}
```

---

## Web UIでのIPプール設定

### IPプールの設定

1. JumboDogXを管理者権限で起動
2. ブラウザで `http://localhost:5001` にアクセス
3. サイドメニューから **Settings** → **DHCP** → **IP Pool** を選択
4. 各フィールドに値を入力:
   - **Bind Address**: DHCPサーバーのIPアドレス
   - **Subnet Mask**: サブネットマスク
   - **Start IP**: IPプールの開始アドレス
   - **End IP**: IPプールの終了アドレス
   - **Lease Time**: リース時間（秒）
5. **Save Settings** ボタンをクリック

![IPプール設定画面](images/dhcp-ip-pool-settings.png)

### DNS/ゲートウェイの設定

1. Settings → DHCP → Networkを選択
2. 各フィールドに値を入力:
   - **DNS Servers**: DNSサーバーのリスト（カンマ区切り）
   - **Gateway**: デフォルトゲートウェイ
3. **Save Settings** ボタンをクリック

![ネットワーク設定画面](images/dhcp-network-settings.png)

### 静的IPの追加

1. Settings → DHCP → Static Leasesを選択
2. **Add Static Lease** ボタンをクリック
3. 各フィールドに値を入力:
   - **MAC Address**: クライアントのMACアドレス
   - **IP Address**: 割り当てるIPアドレス
4. **Add** ボタンをクリック
5. **Save Settings** ボタンをクリック

![静的IP設定画面](images/dhcp-static-lease-add.png)

---

## 設定例集

### 小規模オフィス（10-20台）

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.150",
    "LeaseTime": 86400,
    "DnsServers": ["192.168.1.1", "8.8.8.8"],
    "Gateway": "192.168.1.1"
  }
}
```

### 中規模オフィス（50-100台）

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "192.168.1.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.1.50",
    "EndIp": "192.168.1.200",
    "LeaseTime": 28800,
    "DnsServers": ["192.168.1.1", "8.8.8.8", "8.8.4.4"],
    "Gateway": "192.168.1.1"
  }
}
```

### 開発環境（頻繁な変更）

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "192.168.100.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "192.168.100.10",
    "EndIp": "192.168.100.100",
    "LeaseTime": 3600,
    "DnsServers": ["192.168.100.1"],
    "Gateway": null
  }
}
```

### IoTデバイス環境

```json
{
  "DhcpServer": {
    "Enabled": true,
    "BindAddress": "10.0.0.1",
    "SubnetMask": "255.255.255.0",
    "StartIp": "10.0.0.50",
    "EndIp": "10.0.0.254",
    "LeaseTime": 604800,
    "DnsServers": ["10.0.0.1", "1.1.1.1"],
    "Gateway": "10.0.0.1",
    "StaticLeases": [
      {
        "MacAddress": "AA:BB:CC:DD:EE:01",
        "IpAddress": "10.0.0.10",
        "Description": "Smart TV"
      },
      {
        "MacAddress": "AA:BB:CC:DD:EE:02",
        "IpAddress": "10.0.0.11",
        "Description": "Security Camera"
      }
    ]
  }
}
```

---

## トラブルシューティング

### IPアドレスが割り当てられない

**原因1: IPプールが枯渇している**

**解決方法**: IPプールの範囲を拡大してください

```json
{
  "DhcpServer": {
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.250"  # 範囲を拡大
  }
}
```

---

**原因2: サブネットマスクが間違っている**

**解決方法**: クライアントとDHCPサーバーのサブネットマスクが一致するか確認してください

---

### IPアドレスが重複する

**原因: 静的IPがIPプール内にある**

**解決方法**: 静的IPをIPプールの範囲外に設定してください

```json
{
  "DhcpServer": {
    "StartIp": "192.168.1.100",
    "EndIp": "192.168.1.200",
    "StaticLeases": [
      {
        "MacAddress": "00:11:22:33:44:55",
        "IpAddress": "192.168.1.50"  # プール外に設定
      }
    ]
  }
}
```

---

## 関連リンク

- [クイックスタート](getting-started.md)
- [MAC ACL設定](mac-acl.md)
- [トラブルシューティング](troubleshooting.md)
- [ACL設定](../common/acl-configuration.md)
