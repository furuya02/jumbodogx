@page "/settings/dhcp/macacl"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>DHCP MAC ACL - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>DHCP - MAC Address Access Control</h1>
        <p class="subtitle">Configure MAC address-based access control and static IP assignments</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">MAC Address Based Access Control</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useMacAcl"
                                   @bind="settings.DhcpServer.UseMacAcl">
                            <label class="form-check-label" for="useMacAcl">
                                <strong>Enable MAC ACL</strong>
                            </label>
                        </div>
                        <div class="form-text">
                            When enabled, only MAC addresses in the list will receive IP addresses.
                            This allows for static IP assignment and access control.
                        </div>
                    </div>

                    @if (settings.DhcpServer.UseMacAcl)
                    {
                        <hr />

                        <h6 class="mt-3 mb-3">MAC ACL Entries</h6>

                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">MAC Address</th>
                                    <th style="width: 25%">Assigned IP Address</th>
                                    <th style="width: 35%">Device Name / Comment</th>
                                    <th style="width: 15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!settings.DhcpServer.MacAclList.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            No MAC ACL entries defined. Click "Add Entry" to add one.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var (entry, index) in settings.DhcpServer.MacAclList.Select((e, i) => (e, i)))
                                    {
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" @bind="entry.MacAddress"
                                                       placeholder="00:11:22:33:44:55">
                                                <small class="form-text text-muted">
                                                    Format: XX:XX:XX:XX:XX:XX
                                                </small>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" @bind="entry.V4Address"
                                                       placeholder="192.168.1.50">
                                                <small class="form-text text-muted">
                                                    Static IP to assign
                                                </small>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" @bind="entry.MacName"
                                                       placeholder="Device name or comment">
                                            </td>
                                            <td>
                                                <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveEntry(index)">
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>

                        <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-info mt-2" @onclick="AddEntry">
                            + Add Entry
                        </button>

                        <div class="alert alert-info mt-3">
                            <strong>How MAC ACL Works:</strong>
                            <ul class="mb-0">
                                <li><strong>MAC Address</strong>: The hardware address of the device (e.g., 00:11:22:33:44:55)</li>
                                <li><strong>Assigned IP</strong>: The static IP address to assign to this device</li>
                                <li><strong>Device Name</strong>: Optional description for identification purposes</li>
                            </ul>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <strong>Important:</strong>
                            <ul class="mb-0">
                                <li>When MAC ACL is enabled, only listed devices will receive IP addresses</li>
                                <li>Assigned IP addresses should be outside the dynamic pool range</li>
                                <li>Ensure MAC addresses are in correct format: XX:XX:XX:XX:XX:XX</li>
                            </ul>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary mt-3">
                            <strong>MAC ACL is currently disabled.</strong>
                            Enable it to restrict DHCP access to specific devices and assign static IP addresses.
                        </div>
                    }

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddExampleEntry">
                            Add Example Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void AddEntry()
    {
        settings.DhcpServer.MacAclList.Add(new DhcpMacEntry
        {
            MacAddress = "",
            V4Address = "",
            MacName = ""
        });
    }

    private void RemoveEntry(int index)
    {
        if (index >= 0 && index < settings.DhcpServer.MacAclList.Count)
        {
            settings.DhcpServer.MacAclList.RemoveAt(index);
        }
    }

    private void AddExampleEntry()
    {
        settings.DhcpServer.MacAclList.Add(new DhcpMacEntry
        {
            MacAddress = "00:11:22:33:44:55",
            V4Address = "192.168.1.50",
            MacName = "Example Device"
        });

        saveMessage = "Example entry added. Modify as needed and click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate MAC ACL entries if MAC ACL is enabled
            if (settings.DhcpServer.UseMacAcl)
            {
                var invalidEntries = settings.DhcpServer.MacAclList
                    .Where(e => string.IsNullOrWhiteSpace(e.MacAddress) || string.IsNullOrWhiteSpace(e.V4Address))
                    .ToList();

                if (invalidEntries.Any())
                {
                    saveMessage = "Error: MAC address and IP address fields cannot be empty. Please remove or fill in all entries.";
                    saveSuccess = false;
                    return;
                }

                // Basic MAC address format validation
                var macRegex = new System.Text.RegularExpressions.Regex(@"^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$");
                var invalidMacs = settings.DhcpServer.MacAclList
                    .Where(e => !macRegex.IsMatch(e.MacAddress))
                    .ToList();

                if (invalidMacs.Any())
                {
                    saveMessage = "Error: Invalid MAC address format. Use XX:XX:XX:XX:XX:XX or XX-XX-XX-XX-XX-XX format.";
                    saveSuccess = false;
                    return;
                }
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
