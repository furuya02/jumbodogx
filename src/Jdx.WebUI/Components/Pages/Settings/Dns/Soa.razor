@page "/settings/dns/soa"
@page "/settings/dns/{DomainIndex}/soa"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager

<PageTitle>DNS SOA Settings - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>DNS - SOA Settings@(currentDomain != null ? $" for {currentDomain.Name}" : "")</h1>
        <p class="subtitle">Configure SOA (Start of Authority) records@(currentDomain != null ? $" for {currentDomain.Name}" : " for domains")</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    @if (settings.DnsServer.DomainList.Count == 0)
    {
        <div class="alert alert-warning">
            <strong>No domains configured.</strong> Please add domains in the <a href="/settings/dns/domains">Domain Management</a> page first.
        </div>
    }
    else if (currentDomain == null && !string.IsNullOrEmpty(DomainIndex))
    {
        <div class="alert alert-danger">
            <strong>Domain not found.</strong> The specified domain index is invalid.
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-12">
                <!-- ドメイン選択 -->
                @if (currentDomain == null)
                {
                    <div class="settings-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Select a Domain</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                Select a domain to configure its SOA (Start of Authority) settings.
                            </p>

                            <div class="list-group">
                                @foreach (var (domain, index) in settings.DnsServer.DomainList.Select((d, i) => (d, i)))
                                {
                                    <a href="/settings/dns/@index/soa" class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">@(string.IsNullOrEmpty(domain.Name) ? "(unnamed domain)" : domain.Name)</h6>
                                                <small class="text-muted">@(domain.IsAuthority ? "Authority Domain" : "Non-Authority Domain")</small>
                                            </div>
                                            <span class="badge bg-primary">Configure SOA</span>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- SOA設定カード -->
                    <div class="settings-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">SOA (Start of Authority) Settings for @currentDomain.Name</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                Configure SOA (Start of Authority) record for this domain.
                                SOA records contain essential information about the zone, including the primary nameserver, responsible person's email, and zone timing parameters.
                            </p>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="soaPrimaryNameServer" class="form-label">Primary Name Server</label>
                                    <input type="text" class="form-control" id="soaPrimaryNameServer"
                                           @bind="currentDomain.SoaPrimaryNameServer">
                                    <div class="form-text">Primary nameserver (e.g., ns1.example.com)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="soaMail" class="form-label">Email Address</label>
                                    <input type="text" class="form-control" id="soaMail"
                                           @bind="currentDomain.SoaMail">
                                    <div class="form-text">Responsible person's email (e.g., postmaster)</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="soaSerial" class="form-label">Serial Number</label>
                                    <input type="number" class="form-control" id="soaSerial"
                                           @bind="currentDomain.SoaSerial" min="1">
                                    <div class="form-text">Zone serial number (increment on update)</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="soaRefresh" class="form-label">Refresh (seconds)</label>
                                    <input type="number" class="form-control" id="soaRefresh"
                                           @bind="currentDomain.SoaRefresh" min="1">
                                    <div class="form-text">Secondary nameserver refresh interval (default: 3600)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="soaRetry" class="form-label">Retry (seconds)</label>
                                    <input type="number" class="form-control" id="soaRetry"
                                           @bind="currentDomain.SoaRetry" min="1">
                                    <div class="form-text">Retry interval on failed refresh (default: 300)</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="soaExpire" class="form-label">Expire (seconds)</label>
                                    <input type="number" class="form-control" id="soaExpire"
                                           @bind="currentDomain.SoaExpire" min="1">
                                    <div class="form-text">Zone expiration time (default: 360000)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="soaMinimum" class="form-label">Minimum TTL (seconds)</label>
                                    <input type="number" class="form-control" id="soaMinimum"
                                           @bind="currentDomain.SoaMinimum" min="1">
                                    <div class="form-text">Minimum cache time for negative responses (default: 3600)</div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <strong>SOA Parameters:</strong>
                                <ul class="mb-0">
                                    <li><strong>Primary Name Server</strong>: Primary nameserver for this zone</li>
                                    <li><strong>Email</strong>: Responsible person's email address</li>
                                    <li><strong>Serial</strong>: Zone serial number - increment this when you make changes to the zone</li>
                                    <li><strong>Refresh</strong>: Time interval before the zone should be refreshed</li>
                                    <li><strong>Retry</strong>: Time interval that should elapse before a failed refresh should be retried</li>
                                    <li><strong>Expire</strong>: Time value that specifies the upper limit on the time interval that can elapse before the zone is no longer authoritative</li>
                                    <li><strong>Minimum</strong>: Minimum TTL that should be exported with any RR from this zone</li>
                                </ul>
                            </div>

                            <div class="border-top pt-3 mt-4">
                                <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                                    Save Settings
                                </button>
                                <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="ResetToDefault">
                                    Reset to Default
                                </button>
                                <a href="/settings/dns/soa" class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg">
                                    Back to Domain List
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? DomainIndex { get; set; }

    private ApplicationSettings settings = new();
    private DnsDomainEntry? currentDomain;
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
        LoadDomain();
    }

    protected override void OnParametersSet()
    {
        LoadDomain();
    }

    private void LoadDomain()
    {
        if (!string.IsNullOrEmpty(DomainIndex) &&
            int.TryParse(DomainIndex, out var index) &&
            index >= 0 && index < settings.DnsServer.DomainList.Count)
        {
            currentDomain = settings.DnsServer.DomainList[index];
        }
        else
        {
            currentDomain = null;
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "SOA settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ResetToDefault()
    {
        if (currentDomain != null)
        {
            currentDomain.SoaPrimaryNameServer = "";
            currentDomain.SoaMail = "postmaster";
            currentDomain.SoaSerial = 1;
            currentDomain.SoaRefresh = 3600;
            currentDomain.SoaRetry = 300;
            currentDomain.SoaExpire = 360000;
            currentDomain.SoaMinimum = 3600;

            saveMessage = "SOA settings reset to default values. Click Save to apply.";
            saveSuccess = true;
        }
    }
}
