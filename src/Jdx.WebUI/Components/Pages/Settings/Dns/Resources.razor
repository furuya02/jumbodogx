@page "/settings/dns/resources"
@page "/settings/dns/{DomainIndex}/resources"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>DNS Resources - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>DNS - Resource Records@(currentDomain != null ? $" for {currentDomain.Name}" : "")</h1>
        <p class="subtitle">Configure DNS resource records@(currentDomain != null ? $" for {currentDomain.Name}" : " for authoritative domains")</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">DNS Resource Records@(currentDomain != null ? $" for {currentDomain.Name}" : "")</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Configure DNS resource records for authoritative domains.
                        Supports A (IPv4), AAAA (IPv6), CNAME (alias), MX (mail), NS (nameserver), PTR (reverse), and SOA (zone) records.
                    </p>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 10%">Type</th>
                                <th style="width: 25%">Name</th>
                                <th style="width: 25%">Address / Alias</th>
                                <th style="width: 10%">Priority</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (resource, index) in filteredResources.Select((r, i) => (r, i)))
                            {
                                <tr>
                                    <td>
                                        <select class="form-select" @bind="resource.Type">
                                            <option value="@DnsType.A">A</option>
                                            <option value="@DnsType.Aaaa">AAAA</option>
                                            <option value="@DnsType.Cname">CNAME</option>
                                            <option value="@DnsType.Mx">MX</option>
                                            <option value="@DnsType.Ns">NS</option>
                                            <option value="@DnsType.Ptr">PTR</option>
                                            <option value="@DnsType.Soa">SOA</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" @bind="resource.Name"
                                               placeholder="@GetPlaceholder(resource.Type, "name")">
                                    </td>
                                    <td>
                                        @if (resource.Type == DnsType.Cname)
                                        {
                                            <input type="text" class="form-control" @bind="resource.Alias"
                                                   placeholder="target.example.com">
                                        }
                                        else if (resource.Type == DnsType.A || resource.Type == DnsType.Aaaa ||
                                                 resource.Type == DnsType.Mx || resource.Type == DnsType.Ns ||
                                                 resource.Type == DnsType.Ptr || resource.Type == DnsType.Soa)
                                        {
                                            <input type="text" class="form-control" @bind="resource.Address"
                                                   placeholder="@GetPlaceholder(resource.Type, "address")">
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" disabled placeholder="N/A">
                                        }
                                    </td>
                                    <td>
                                        @if (resource.Type == DnsType.Mx)
                                        {
                                            <input type="number" class="form-control" @bind="resource.Priority" min="0" max="65535">
                                        }
                                        else
                                        {
                                            <input type="number" class="form-control" disabled placeholder="N/A">
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveResource(resource)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-primary mt-2" @onclick="AddResource">
                        + Add Resource Record
                    </button>

                    <div class="alert alert-info mt-3">
                        <strong>Record Types:</strong>
                        <ul class="mb-0">
                            <li><strong>A</strong>: Maps hostname to IPv4 address (e.g., example.com -> 192.0.2.1)</li>
                            <li><strong>AAAA</strong>: Maps hostname to IPv6 address (e.g., example.com -> 2001:db8::1)</li>
                            <li><strong>CNAME</strong>: Alias (canonical name) pointing to another hostname</li>
                            <li><strong>MX</strong>: Mail exchange server (requires priority)</li>
                            <li><strong>NS</strong>: Nameserver for a domain</li>
                            <li><strong>PTR</strong>: Reverse DNS (IP to hostname)</li>
                            <li><strong>SOA</strong>: Start of Authority (automatically generated for NS records)</li>
                        </ul>
                    </div>

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddExampleRecords">
                            Add Examples
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? DomainIndex { get; set; }

    private ApplicationSettings settings = new();
    private DnsDomainEntry? currentDomain;
    private List<DnsResourceEntry> filteredResources = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
        LoadDomainAndFilter();
    }

    protected override void OnParametersSet()
    {
        LoadDomainAndFilter();
    }

    private void LoadDomainAndFilter()
    {
        if (!string.IsNullOrEmpty(DomainIndex) &&
            int.TryParse(DomainIndex, out var index) &&
            index >= 0 && index < settings.DnsServer.DomainList.Count)
        {
            // Specific domain - filter resources
            currentDomain = settings.DnsServer.DomainList[index];
            FilterResources();
        }
        else
        {
            // All domains - show all resources
            currentDomain = null;
            filteredResources = settings.DnsServer.ResourceList;
        }
    }

    private void FilterResources()
    {
        if (currentDomain != null && !string.IsNullOrEmpty(currentDomain.Name))
        {
            filteredResources = settings.DnsServer.ResourceList
                .Where(r => r.Name == currentDomain.Name || r.Name.EndsWith("." + currentDomain.Name))
                .ToList();
        }
        else
        {
            filteredResources = settings.DnsServer.ResourceList;
        }
    }

    private void AddResource()
    {
        var newResource = new DnsResourceEntry
        {
            Type = DnsType.A,
            Name = currentDomain?.Name ?? "",
            Alias = "",
            Address = "",
            Priority = 0
        };
        settings.DnsServer.ResourceList.Add(newResource);
        LoadDomainAndFilter();
    }

    private void RemoveResource(DnsResourceEntry resource)
    {
        settings.DnsServer.ResourceList.Remove(resource);
        LoadDomainAndFilter();
    }

    private void AddExampleRecords()
    {
        if (currentDomain != null)
        {
            // Add examples for specific domain
            var domainName = currentDomain.Name;

            // Add A record for domain
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == domainName && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = domainName,
                    Address = "192.0.2.1",
                    Priority = 0
                });
            }

            // Add www CNAME record
            var wwwName = "www." + domainName;
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == wwwName && r.Type == DnsType.Cname))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Cname,
                    Name = wwwName,
                    Alias = domainName,
                    Priority = 0
                });
            }

            // Add MX record
            var mailName = "mail." + domainName;
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == domainName && r.Type == DnsType.Mx))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Mx,
                    Name = domainName,
                    Address = mailName,
                    Priority = 10
                });
            }
        }
        else
        {
            // Add general examples
            // Add localhost A record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "localhost" && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = "localhost",
                    Address = "127.0.0.1",
                    Priority = 0
                });
            }

            // Add localhost AAAA record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "localhost" && r.Type == DnsType.Aaaa))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Aaaa,
                    Name = "localhost",
                    Address = "::1",
                    Priority = 0
                });
            }

            // Add test.local A record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "test.local" && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = "test.local",
                    Address = "192.168.1.100",
                    Priority = 0
                });
            }
        }

        LoadDomainAndFilter();
        saveMessage = "Example resource records added. Click Save to apply.";
        saveSuccess = true;
    }

    private string GetPlaceholder(DnsType type, string field)
    {
        var exampleDomain = currentDomain?.Name ?? "example.com";

        if (field == "name")
        {
            return type switch
            {
                DnsType.A => exampleDomain,
                DnsType.Aaaa => exampleDomain,
                DnsType.Cname => "www." + exampleDomain,
                DnsType.Mx => exampleDomain,
                DnsType.Ns => exampleDomain,
                DnsType.Ptr => "1.0.168.192.in-addr.arpa",
                DnsType.Soa => exampleDomain,
                _ => "hostname"
            };
        }
        else if (field == "address")
        {
            return type switch
            {
                DnsType.A => "192.0.2.1",
                DnsType.Aaaa => "2001:db8::1",
                DnsType.Mx => "mail." + exampleDomain,
                DnsType.Ns => "ns1." + exampleDomain,
                DnsType.Ptr => exampleDomain,
                DnsType.Soa => "ns1." + exampleDomain,
                _ => ""
            };
        }
        return "";
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate resources
            var emptyResources = settings.DnsServer.ResourceList
                .Where(r => string.IsNullOrWhiteSpace(r.Name))
                .ToList();

            if (emptyResources.Any())
            {
                saveMessage = "Error: Resource name cannot be empty. Please remove or fill in all records.";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
