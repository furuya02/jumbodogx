@page "/settings/dns/resources"
@page "/settings/dns/{DomainIndex}/resources"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>DNS Resources - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>DNS - Resource Records@(currentDomain != null ? $" for {currentDomain.Name}" : "")</h1>
        <p class="subtitle">Configure DNS resource records@(currentDomain != null ? $" for {currentDomain.Name}" : " for authoritative domains")</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            @if (currentDomain != null)
            {
                <!-- SOA Settings Table -->
                <div class="settings-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">SOA (Start of Authority) Settings for @currentDomain.Name</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Configure SOA record parameters for this domain.
                        </p>

                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%">Primary Name Server</th>
                                    <th style="width: 20%">Mail address</th>
                                    <th style="width: 12%">Serial</th>
                                    <th style="width: 12%">Refresh</th>
                                    <th style="width: 12%">Retry</th>
                                    <th style="width: 12%">Expire</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <input type="text" class="form-control" @bind="currentDomain.SoaPrimaryNameServer"
                                               placeholder="ns1.@currentDomain.Name">
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" @bind="currentDomain.SoaMail"
                                               placeholder="postmaster">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="currentDomain.SoaSerial" min="1">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="currentDomain.SoaRefresh" min="1">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="currentDomain.SoaRetry" min="1">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="currentDomain.SoaExpire" min="1">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">DNS Resource Records@(currentDomain != null ? $" for {currentDomain.Name}" : "")</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Configure DNS resource records for authoritative domains.
                        Supports A (IPv4), AAAA (IPv6), CNAME (alias), MX (mail), NS (nameserver), and PTR (reverse) records.
                    </p>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%">Name</th>
                                <th style="width: 10%">Type</th>
                                <th style="width: 35%">Value</th>
                                <th style="width: 10%">TTL</th>
                                <th style="width: 10%">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (resource, index) in filteredResources.Select((r, i) => (r, i)))
                            {
                                <tr>
                                    <td>
                                        <input type="text" class="form-control" @bind="resource.Name"
                                               placeholder="@GetPlaceholder(resource.Type, "name")">
                                    </td>
                                    <td>
                                        <select class="form-select" @bind="resource.Type">
                                            <option value="@DnsType.A">A</option>
                                            <option value="@DnsType.Aaaa">AAAA</option>
                                            <option value="@DnsType.Cname">CNAME</option>
                                            <option value="@DnsType.Mx">MX</option>
                                            <option value="@DnsType.Ns">NS</option>
                                            <option value="@DnsType.Ptr">PTR</option>
                                        </select>
                                    </td>
                                    <td>
                                        @if (resource.Type == DnsType.Ns)
                                        {
                                            <!-- NS レコード: 複数のネームサーバーを入力 -->
                                            <div class="ns-servers-container">
                                                @for (int i = 0; i < resource.NameServers.Count; i++)
                                                {
                                                    var nsIndex = i;
                                                    <div class="input-group mb-2">
                                                        <input type="text" class="form-control form-control-sm"
                                                               @bind="resource.NameServers[nsIndex]"
                                                               placeholder="ns1.example.com">
                                                        <button class="btn btn-outline-danger btn-sm" type="button"
                                                                @onclick="() => RemoveNameServer(resource, nsIndex)">
                                                            ×
                                                        </button>
                                                    </div>
                                                }
                                                <button class="btn btn-outline-primary btn-sm" type="button"
                                                        @onclick="() => AddNameServer(resource)">
                                                    + ネームサーバー追加
                                                </button>
                                            </div>
                                        }
                                        else if (resource.Type == DnsType.Mx)
                                        {
                                            <!-- MX レコード: Priority + Address -->
                                            <div class="input-group">
                                                <span class="input-group-text">Priority</span>
                                                <input type="number" class="form-control" style="max-width: 80px;"
                                                       @bind="resource.Priority" min="0" max="65535">
                                                <input type="text" class="form-control" @bind="resource.Address"
                                                       placeholder="mail.example.com">
                                            </div>
                                        }
                                        else if (resource.Type == DnsType.Cname)
                                        {
                                            <input type="text" class="form-control" @bind="resource.Alias"
                                                   placeholder="target.example.com">
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" @bind="resource.Address"
                                                   placeholder="@GetPlaceholder(resource.Type, "address")">
                                        }
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="resource.Ttl" min="1" max="2147483647">
                                    </td>
                                    <td>
                                        <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveResource(resource)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-primary mt-2" @onclick="AddResource">
                        + Add Resource Record
                    </button>

                    <div class="alert alert-info mt-3">
                        <strong>レコードタイプ:</strong>
                        <ul class="mb-0">
                            <li><strong>A</strong>: ホスト名をIPv4アドレスにマッピング (例: example.com -> 192.0.2.1)</li>
                            <li><strong>AAAA</strong>: ホスト名をIPv6アドレスにマッピング (例: example.com -> 2001:db8::1)</li>
                            <li><strong>CNAME</strong>: 別のホスト名を指すエイリアス（正規名）</li>
                            <li><strong>MX</strong>: メール交換サーバー（優先度が必要）</li>
                            <li><strong>NS</strong>: ドメインのネームサーバー（複数指定可能）</li>
                            <li><strong>PTR</strong>: 逆引きDNS（IPからホスト名）</li>
                        </ul>
                        <p class="mt-2 mb-0"><strong>TTL (Time To Live)</strong>: レコードがキャッシュされる時間（秒単位）。デフォルトは3600秒（1時間）です。</p>
                        <p class="mt-2 mb-0"><strong>SOA</strong>: SOA (Start of Authority) レコードは上部のSOA設定テーブルで設定してください。</p>
                    </div>

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddExampleRecords">
                            Add Examples
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? DomainIndex { get; set; }

    private ApplicationSettings settings = new();
    private DnsDomainEntry? currentDomain;
    private List<DnsResourceEntry> filteredResources = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
        LoadDomainAndFilter();
    }

    protected override void OnParametersSet()
    {
        LoadDomainAndFilter();
    }

    private void LoadDomainAndFilter()
    {
        if (!string.IsNullOrEmpty(DomainIndex) &&
            int.TryParse(DomainIndex, out var index) &&
            index >= 0 && index < settings.DnsServer.DomainList.Count)
        {
            // Specific domain - filter resources
            currentDomain = settings.DnsServer.DomainList[index];
            FilterResources();
        }
        else
        {
            // All domains - show all resources
            currentDomain = null;
            filteredResources = settings.DnsServer.ResourceList;
        }
    }

    private void FilterResources()
    {
        if (currentDomain != null && !string.IsNullOrEmpty(currentDomain.Name))
        {
            filteredResources = settings.DnsServer.ResourceList
                .Where(r => r.Name == currentDomain.Name || r.Name.EndsWith("." + currentDomain.Name))
                .ToList();
        }
        else
        {
            filteredResources = settings.DnsServer.ResourceList;
        }
    }

    private void AddResource()
    {
        var newResource = new DnsResourceEntry
        {
            Type = DnsType.A,
            Name = currentDomain?.Name ?? "",
            Alias = "",
            Address = "",
            Priority = 0,
            Ttl = 3600,
            NameServers = new List<string>()
        };
        settings.DnsServer.ResourceList.Add(newResource);
        LoadDomainAndFilter();
    }

    private void RemoveResource(DnsResourceEntry resource)
    {
        settings.DnsServer.ResourceList.Remove(resource);
        LoadDomainAndFilter();
    }

    private void AddNameServer(DnsResourceEntry resource)
    {
        resource.NameServers.Add("");
    }

    private void RemoveNameServer(DnsResourceEntry resource, int index)
    {
        if (index >= 0 && index < resource.NameServers.Count)
        {
            resource.NameServers.RemoveAt(index);
        }
    }

    private void AddExampleRecords()
    {
        if (currentDomain != null)
        {
            // Add examples for specific domain
            var domainName = currentDomain.Name;

            // Add A record for domain
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == domainName && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = domainName,
                    Address = "192.0.2.1",
                    Priority = 0,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }

            // Add www CNAME record
            var wwwName = "www." + domainName;
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == wwwName && r.Type == DnsType.Cname))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Cname,
                    Name = wwwName,
                    Alias = domainName,
                    Priority = 0,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }

            // Add MX record
            var mailName = "mail." + domainName;
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == domainName && r.Type == DnsType.Mx))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Mx,
                    Name = domainName,
                    Address = mailName,
                    Priority = 10,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }
        }
        else
        {
            // Add general examples
            // Add localhost A record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "localhost" && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = "localhost",
                    Address = "127.0.0.1",
                    Priority = 0,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }

            // Add localhost AAAA record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "localhost" && r.Type == DnsType.Aaaa))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.Aaaa,
                    Name = "localhost",
                    Address = "::1",
                    Priority = 0,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }

            // Add test.local A record
            if (!settings.DnsServer.ResourceList.Any(r => r.Name == "test.local" && r.Type == DnsType.A))
            {
                settings.DnsServer.ResourceList.Add(new DnsResourceEntry
                {
                    Type = DnsType.A,
                    Name = "test.local",
                    Address = "192.168.1.100",
                    Priority = 0,
                    Ttl = 3600,
                    NameServers = new List<string>()
                });
            }
        }

        LoadDomainAndFilter();
        saveMessage = "Example resource records added. Click Save to apply.";
        saveSuccess = true;
    }

    private string GetPlaceholder(DnsType type, string field)
    {
        var exampleDomain = currentDomain?.Name ?? "example.com";

        if (field == "name")
        {
            return type switch
            {
                DnsType.A => exampleDomain,
                DnsType.Aaaa => exampleDomain,
                DnsType.Cname => "www." + exampleDomain,
                DnsType.Mx => exampleDomain,
                DnsType.Ns => exampleDomain,
                DnsType.Ptr => "1.0.168.192.in-addr.arpa",
                DnsType.Soa => exampleDomain,
                _ => "hostname"
            };
        }
        else if (field == "address")
        {
            return type switch
            {
                DnsType.A => "192.0.2.1",
                DnsType.Aaaa => "2001:db8::1",
                DnsType.Mx => "mail." + exampleDomain,
                DnsType.Ns => "ns1." + exampleDomain,
                DnsType.Ptr => exampleDomain,
                DnsType.Soa => "ns1." + exampleDomain,
                _ => ""
            };
        }
        return "";
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate resources
            var emptyResources = settings.DnsServer.ResourceList
                .Where(r => string.IsNullOrWhiteSpace(r.Name))
                .ToList();

            if (emptyResources.Any())
            {
                saveMessage = "Error: Resource name cannot be empty. Please remove or fill in all records.";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
