@page "/settings/pop3/changepassword"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>POP3 Change Password Settings - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>POP3 - Change Password Settings</h1>
        <p class="subtitle">Configure password change functionality and password policy requirements</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-10">
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Change Password (CHPS) Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="useChps"
                                   @bind="settings.Pop3Server.UseChps">
                            <label class="form-check-label" for="useChps">
                                <strong>Enable Change Password Feature</strong>
                            </label>
                        </div>
                        <div class="form-text">
                            Allow users to change their passwords via POP3 protocol using CHPS extension.
                        </div>
                    </div>

                    @if (settings.Pop3Server.UseChps)
                    {
                        <hr />

                        <h6 class="mt-3 mb-3">Password Policy</h6>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="minimumLength" class="form-label">Minimum Password Length</label>
                                <input type="number" class="form-control" id="minimumLength"
                                       @bind="settings.Pop3Server.MinimumLength" min="1" max="128">
                                <div class="form-text">Minimum number of characters required (default: 8)</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="disableJoe"
                                           @bind="settings.Pop3Server.DisableJoe">
                                    <label class="form-check-label" for="disableJoe">
                                        <strong>Disable Joe Account Pattern</strong>
                                    </label>
                                </div>
                                <div class="form-text">
                                    Prevent using username-based passwords (e.g., username "joe" with password "joe123")
                                </div>
                            </div>
                        </div>

                        <hr />

                        <h6 class="mt-3 mb-3">Character Requirements</h6>

                        <div class="alert alert-info mb-3">
                            <strong>Password Strength:</strong> Enable character requirements to enforce stronger passwords.
                            When enabled, passwords must contain at least one character from each selected category.
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useNum"
                                           @bind="settings.Pop3Server.UseNum">
                                    <label class="form-check-label" for="useNum">
                                        <strong>Require Numbers</strong>
                                    </label>
                                </div>
                                <div class="form-text">Must contain at least one digit (0-9)</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useSmall"
                                           @bind="settings.Pop3Server.UseSmall">
                                    <label class="form-check-label" for="useSmall">
                                        <strong>Require Lowercase Letters</strong>
                                    </label>
                                </div>
                                <div class="form-text">Must contain at least one lowercase letter (a-z)</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useLarge"
                                           @bind="settings.Pop3Server.UseLarge">
                                    <label class="form-check-label" for="useLarge">
                                        <strong>Require Uppercase Letters</strong>
                                    </label>
                                </div>
                                <div class="form-text">Must contain at least one uppercase letter (A-Z)</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useSign"
                                           @bind="settings.Pop3Server.UseSign">
                                    <label class="form-check-label" for="useSign">
                                        <strong>Require Special Characters</strong>
                                    </label>
                                </div>
                                <div class="form-text">Must contain at least one special character (!@@#$%^&*)</div>
                            </div>
                        </div>

                        @if (settings.Pop3Server.UseNum || settings.Pop3Server.UseSmall ||
                             settings.Pop3Server.UseLarge || settings.Pop3Server.UseSign)
                        {
                            <div class="alert alert-success mt-3">
                                <strong>Current Password Requirements:</strong>
                                <ul class="mb-0">
                                    <li>Minimum length: @settings.Pop3Server.MinimumLength characters</li>
                                    @if (settings.Pop3Server.UseNum)
                                    {
                                        <li>At least one number (0-9)</li>
                                    }
                                    @if (settings.Pop3Server.UseSmall)
                                    {
                                        <li>At least one lowercase letter (a-z)</li>
                                    }
                                    @if (settings.Pop3Server.UseLarge)
                                    {
                                        <li>At least one uppercase letter (A-Z)</li>
                                    }
                                    @if (settings.Pop3Server.UseSign)
                                    {
                                        <li>At least one special character (!@@#$%^&*)</li>
                                    }
                                    @if (settings.Pop3Server.DisableJoe)
                                    {
                                        <li>Cannot be based on username</li>
                                    }
                                </ul>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-secondary mt-3">
                            <strong>Change Password feature is currently disabled.</strong>
                            Enable it to allow users to change their passwords via POP3 protocol.
                        </div>
                    }

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="ResetToDefault">
                            Reset to Default
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private async Task SaveSettings()
    {
        try
        {
            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ResetToDefault()
    {
        var defaults = SettingsService.GetDefaultSettings();
        settings.Pop3Server.UseChps = defaults.Pop3Server.UseChps;
        settings.Pop3Server.MinimumLength = defaults.Pop3Server.MinimumLength;
        settings.Pop3Server.DisableJoe = defaults.Pop3Server.DisableJoe;
        settings.Pop3Server.UseNum = defaults.Pop3Server.UseNum;
        settings.Pop3Server.UseSmall = defaults.Pop3Server.UseSmall;
        settings.Pop3Server.UseLarge = defaults.Pop3Server.UseLarge;
        settings.Pop3Server.UseSign = defaults.Pop3Server.UseSign;
        saveMessage = "Settings reset to default values. Click Save to apply.";
        saveSuccess = true;
    }
}
