@page "/settings/smtp/host"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>SMTP Host Settings - JumboDogX</PageTitle>

<h1>SMTP - Smart Host Settings</h1>

@if (saveMessage != null)
{
    <div class="alert @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @saveMessage
        <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
    </div>
}

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üñ•Ô∏è Smart Host Configuration</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <strong>Smart Host:</strong>
                    Configure external SMTP servers to use for outgoing mail delivery.
                    Messages will be routed through these hosts instead of direct delivery.
                    Useful when your server is behind a firewall or requires relay through ISP mail servers.
                </div>

                <h6 class="mt-3 mb-3">SMTP Hosts</h6>

                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%">Host Name</th>
                            <th style="width: 25%">Port</th>
                            <th style="width: 15%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!settings.SmtpServer.HostList.Any())
                        {
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    No smart hosts configured. Direct delivery will be used.
                                    Click "Add Host" to configure a smart host.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var (host, index) in settings.SmtpServer.HostList.Select((h, i) => (h, i)))
                            {
                                <tr>
                                    <td>
                                        <input type="text" class="form-control" @bind="host.HostName"
                                               placeholder="smtp.example.com">
                                        <small class="form-text text-muted">
                                            SMTP server hostname or IP address
                                        </small>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" @bind="host.Port"
                                               min="1" max="65535">
                                        <small class="form-text text-muted">
                                            Default: 25
                                        </small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" @onclick="() => RemoveHost(index)">
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                <button class="btn btn-success btn-sm mt-2" @onclick="AddHost">
                    + Add Host
                </button>

                <div class="alert alert-warning mt-3">
                    <strong>Important Notes:</strong>
                    <ul class="mb-0">
                        <li>Hosts are tried in order until delivery succeeds</li>
                        <li>If all smart hosts fail, the message will be queued for retry</li>
                        <li>Smart hosts must allow relay from your server's IP address</li>
                        <li>Port 25 is standard SMTP, port 587 is submission (often requires STARTTLS)</li>
                        <li>Authentication to smart hosts can be configured separately</li>
                    </ul>
                </div>

                <div class="alert alert-success mt-3">
                    <strong>Common Smart Host Configurations:</strong>
                    <ul class="mb-0">
                        <li><strong>Gmail:</strong> smtp.gmail.com:587 (requires authentication and TLS)</li>
                        <li><strong>Office 365:</strong> smtp.office365.com:587 (requires authentication and TLS)</li>
                        <li><strong>ISP SMTP:</strong> Check with your ISP for their SMTP server details</li>
                        <li><strong>Local Relay:</strong> Use another server on your network as relay</li>
                    </ul>
                </div>

                <div class="border-top pt-3 mt-4">
                    <button class="btn btn-primary me-2" @onclick="SaveSettings">
                        Save Settings
                    </button>
                    <button class="btn btn-secondary" @onclick="AddExampleHost">
                        Add Example Host
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void AddHost()
    {
        settings.SmtpServer.HostList.Add(new SmtpHostEntry
        {
            HostName = "",
            Port = 25
        });
    }

    private void RemoveHost(int index)
    {
        if (index >= 0 && index < settings.SmtpServer.HostList.Count)
        {
            settings.SmtpServer.HostList.RemoveAt(index);
        }
    }

    private void AddExampleHost()
    {
        settings.SmtpServer.HostList.Add(new SmtpHostEntry
        {
            HostName = "mail.example.com",
            Port = 25
        });

        saveMessage = "Example host added. Modify as needed and click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate host entries
            var invalidHosts = settings.SmtpServer.HostList
                .Where(h => string.IsNullOrWhiteSpace(h.HostName))
                .ToList();

            if (invalidHosts.Any())
            {
                saveMessage = "Error: Host name cannot be empty. Please remove or fill in all entries.";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
