@page "/settings/smtp/header"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>SMTP Header Settings - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>SMTP - Header Manipulation</h1>
        <p class="subtitle">Configure header pattern matching and append rules for message processing</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <!-- パターンマッチング（削除） -->
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Header Pattern Matching (Remove/Reject)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Header Pattern Matching:</strong>
                        Define patterns to match against message headers. Matched messages can be deleted or rejected.
                        Useful for spam filtering and content control.
                    </div>

                    <h6 class="mt-3 mb-3">Pattern Rules</h6>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60%">Pattern (Header Content)</th>
                                <th style="width: 25%">Action</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!settings.SmtpServer.PatternList.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No header patterns defined. Click "Add Pattern" to add one.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var (pattern, index) in settings.SmtpServer.PatternList.Select((p, i) => (p, i)))
                                {
                                    <tr>
                                        <td>
                                            <input type="text" class="form-control" @bind="pattern.Pattern"
                                                   placeholder="X-Spam-Flag: YES">
                                            <small class="form-text text-muted">
                                                Pattern to match in headers (case-insensitive)
                                            </small>
                                        </td>
                                        <td>
                                            <select class="form-select" @bind="pattern.Action">
                                                <option value="0">Delete</option>
                                                <option value="1">Reject</option>
                                            </select>
                                            <small class="form-text text-muted">
                                                @if (pattern.Action == 0)
                                                {
                                                    <span>Silently delete</span>
                                                }
                                                else
                                                {
                                                    <span>Reject with error</span>
                                                }
                                            </small>
                                        </td>
                                        <td>
                                            <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemovePattern(index)">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-info mt-2" @onclick="AddPattern">
                        + Add Pattern
                    </button>

                    <div class="alert alert-warning mt-3">
                        <strong>Pattern Matching Examples:</strong>
                        <ul class="mb-0">
                            <li><code>X-Spam-Flag: YES</code> - Match spam-flagged messages</li>
                            <li><code>X-Virus</code> - Match virus-detected messages</li>
                            <li><code>Subject: ***SPAM***</code> - Match spam subjects</li>
                            <li>Matching is case-insensitive and partial (substring match)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ヘッダー追加 -->
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Header Append Rules</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Header Append:</strong>
                        Add custom headers to outgoing messages. Useful for branding, tracking, or compliance.
                    </div>

                    <h6 class="mt-3 mb-3">Append Rules</h6>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 35%">Header Name</th>
                                <th style="width: 50%">Header Value</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!settings.SmtpServer.AppendList.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No header append rules defined. Click "Add Header" to add one.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var (append, index) in settings.SmtpServer.AppendList.Select((a, i) => (a, i)))
                                {
                                    <tr>
                                        <td>
                                            <input type="text" class="form-control" @bind="append.Header"
                                                   placeholder="X-Mailer">
                                            <small class="form-text text-muted">
                                                Header field name
                                            </small>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" @bind="append.Value"
                                                   placeholder="JumboDogX SMTP Server">
                                            <small class="form-text text-muted">
                                                Header field value
                                            </small>
                                        </td>
                                        <td>
                                            <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveAppend(index)">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-info mt-2" @onclick="AddAppend">
                        + Add Header
                    </button>

                    <div class="alert alert-success mt-3">
                        <strong>Common Custom Headers:</strong>
                        <ul class="mb-0">
                            <li><code>X-Mailer: JumboDogX</code> - Identify mail server software</li>
                            <li><code>X-Organization: Company Name</code> - Organization identifier</li>
                            <li><code>X-Priority: 1</code> - Set message priority (1=high, 3=normal, 5=low)</li>
                            <li><code>X-Custom-ID: [value]</code> - Custom tracking identifier</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="border-top pt-3 mt-4">
                <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                    Save Settings
                </button>
                <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddExamples">
                    Add Example Rules
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void AddPattern()
    {
        settings.SmtpServer.PatternList.Add(new SmtpHeaderPatternEntry
        {
            Pattern = "",
            Action = 0
        });
    }

    private void RemovePattern(int index)
    {
        if (index >= 0 && index < settings.SmtpServer.PatternList.Count)
        {
            settings.SmtpServer.PatternList.RemoveAt(index);
        }
    }

    private void AddAppend()
    {
        settings.SmtpServer.AppendList.Add(new SmtpHeaderAppendEntry
        {
            Header = "",
            Value = ""
        });
    }

    private void RemoveAppend(int index)
    {
        if (index >= 0 && index < settings.SmtpServer.AppendList.Count)
        {
            settings.SmtpServer.AppendList.RemoveAt(index);
        }
    }

    private void AddExamples()
    {
        // Add example pattern
        if (!settings.SmtpServer.PatternList.Any(p => p.Pattern == "X-Spam"))
        {
            settings.SmtpServer.PatternList.Add(new SmtpHeaderPatternEntry
            {
                Pattern = "X-Spam",
                Action = 0
            });
        }

        // Add example append
        if (!settings.SmtpServer.AppendList.Any(a => a.Header == "X-Mailer"))
        {
            settings.SmtpServer.AppendList.Add(new SmtpHeaderAppendEntry
            {
                Header = "X-Mailer",
                Value = "JumboDogX"
            });
        }

        saveMessage = "Example rules added. Modify as needed and click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate entries
            var invalidPatterns = settings.SmtpServer.PatternList
                .Where(p => string.IsNullOrWhiteSpace(p.Pattern))
                .ToList();

            var invalidAppends = settings.SmtpServer.AppendList
                .Where(a => string.IsNullOrWhiteSpace(a.Header) || string.IsNullOrWhiteSpace(a.Value))
                .ToList();

            if (invalidPatterns.Any())
            {
                saveMessage = "Error: Pattern cannot be empty. Please remove or fill in all entries.";
                saveSuccess = false;
                return;
            }

            if (invalidAppends.Any())
            {
                saveMessage = "Error: Header name and value cannot be empty. Please remove or fill in all entries.";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
