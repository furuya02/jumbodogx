@page "/settings/smtp/autoreception"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>SMTP Auto Reception Settings - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>SMTP - Auto Reception (Fetch)</h1>
        <p class="subtitle">Configure automatic mail retrieval from external POP3/IMAP servers</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Auto Reception Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Auto Reception (Fetch):</strong>
                        Automatically retrieve mail from external POP3/IMAP servers at regular intervals.
                        Useful for collecting mail from ISP accounts or consolidating multiple mailboxes.
                    </div>

                    <h6 class="mt-3 mb-3">Fetch Accounts</h6>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%">Server</th>
                                <th style="width: 8%">Port</th>
                                <th style="width: 15%">Username</th>
                                <th style="width: 12%">Password</th>
                                <th style="width: 10%">Interval (s)</th>
                                <th style="width: 8%">Max</th>
                                <th style="width: 12%">Options</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!settings.SmtpServer.FetchList.Any())
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        No fetch accounts configured. Click "Add Account" to add one.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var (fetch, index) in settings.SmtpServer.FetchList.Select((f, i) => (f, i)))
                                {
                                    <tr>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" @bind="fetch.Server"
                                                   placeholder="pop.example.com">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" @bind="fetch.Port"
                                                   min="1" max="65535">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" @bind="fetch.UserName"
                                                   placeholder="user@example.com">
                                        </td>
                                        <td>
                                            <input type="password" class="form-control form-control-sm" @bind="fetch.Password"
                                                   placeholder="password">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" @bind="fetch.Interval"
                                                   min="60" max="86400">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" @bind="fetch.MaxCount"
                                                   min="1" max="1000">
                                        </td>
                                        <td>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" @bind="fetch.UseSsl"
                                                       id="ssl_@index">
                                                <label class="form-check-label" for="ssl_@index">SSL</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" @bind="fetch.UseApop"
                                                       id="apop_@index">
                                                <label class="form-check-label" for="apop_@index">APOP</label>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveFetch(index)">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-info mt-2" @onclick="AddFetch">
                        + Add Account
                    </button>

                    <div class="alert alert-success mt-3">
                        <strong>Field Descriptions:</strong>
                        <ul class="mb-0">
                            <li><strong>Server:</strong> POP3/IMAP server hostname (e.g., pop.gmail.com)</li>
                            <li><strong>Port:</strong> Server port (110 for POP3, 995 for POP3S, 143 for IMAP, 993 for IMAPS)</li>
                            <li><strong>Username:</strong> Email address or username for authentication</li>
                            <li><strong>Password:</strong> Account password (will be encrypted when saved)</li>
                            <li><strong>Interval:</strong> Fetch interval in seconds (minimum 60)</li>
                            <li><strong>Max:</strong> Maximum messages to retrieve per fetch (prevents overload)</li>
                            <li><strong>SSL:</strong> Use SSL/TLS encryption (recommended for security)</li>
                            <li><strong>APOP:</strong> Use APOP authentication instead of plain text (POP3 only)</li>
                        </ul>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <strong>Important Notes:</strong>
                        <ul class="mb-0">
                            <li>Fetched messages are retrieved via POP3 and delivered to local mailboxes</li>
                            <li>Messages are typically deleted from the remote server after successful fetch</li>
                            <li>Use SSL/TLS when available for secure communication</li>
                            <li>Set appropriate intervals to avoid overloading remote servers</li>
                            <li>Gmail requires "Allow less secure apps" or App Password for POP3 access</li>
                            <li>Test connectivity before enabling auto-fetch to avoid authentication lockouts</li>
                        </ul>
                    </div>

                    <div class="alert alert-info mt-3">
                        <strong>Common Email Provider Settings:</strong>
                        <ul class="mb-0">
                            <li><strong>Gmail:</strong> pop.gmail.com:995 (SSL enabled)</li>
                            <li><strong>Outlook/Hotmail:</strong> outlook.office365.com:995 (SSL enabled)</li>
                            <li><strong>Yahoo:</strong> pop.mail.yahoo.com:995 (SSL enabled)</li>
                            <li><strong>AOL:</strong> pop.aol.com:995 (SSL enabled)</li>
                        </ul>
                    </div>

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddExampleAccount">
                            Add Example Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void AddFetch()
    {
        settings.SmtpServer.FetchList.Add(new SmtpFetchEntry
        {
            Server = "",
            Port = 110,
            UserName = "",
            Password = "",
            Interval = 300,
            MaxCount = 100,
            UseSsl = false,
            UseApop = false
        });
    }

    private void RemoveFetch(int index)
    {
        if (index >= 0 && index < settings.SmtpServer.FetchList.Count)
        {
            settings.SmtpServer.FetchList.RemoveAt(index);
        }
    }

    private void AddExampleAccount()
    {
        settings.SmtpServer.FetchList.Add(new SmtpFetchEntry
        {
            Server = "pop.example.com",
            Port = 110,
            UserName = "user@example.com",
            Password = "REPLACE_WITH_PASSWORD",
            Interval = 300,
            MaxCount = 100,
            UseSsl = false,
            UseApop = false
        });

        saveMessage = "Example account added. Modify as needed and click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate fetch entries
            var invalidFetches = settings.SmtpServer.FetchList
                .Where(f => string.IsNullOrWhiteSpace(f.Server) ||
                           string.IsNullOrWhiteSpace(f.UserName) ||
                           string.IsNullOrWhiteSpace(f.Password))
                .ToList();

            if (invalidFetches.Any())
            {
                saveMessage = "Error: Server, username, and password cannot be empty. Please remove or fill in all entries.";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
