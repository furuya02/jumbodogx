@page "/settings/smtp/aliases"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>SMTP Aliases Settings - JumboDogX</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>SMTP - Mail Aliases</h1>
        <p class="subtitle">Configure email address aliases and forwarding rules</p>
    </div>

    @if (saveMessage != null)
    {
        <div class="alert-modern @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @saveMessage
            <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Mail Alias Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Mail Aliases:</strong>
                        Configure email address aliases (forwarding rules). Messages sent to an alias address
                        will be automatically forwarded to the real user account.
                        Useful for role-based addresses like postmaster, webmaster, admin, etc.
                    </div>

                    <h6 class="mt-3 mb-3">Alias Mappings</h6>

                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40%">Alias Address</th>
                                <th style="width: 45%">Real User Account</th>
                                <th style="width: 15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!settings.SmtpServer.AliasList.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No aliases defined. Click "Add Alias" to add one.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var (alias, index) in settings.SmtpServer.AliasList.Select((a, i) => (a, i)))
                                {
                                    <tr>
                                        <td>
                                            <input type="text" class="form-control" @bind="alias.AliasName"
                                                   placeholder="postmaster">
                                            <small class="form-text text-muted">
                                                Alias address (local part only, no @@domain)
                                            </small>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" @bind="alias.UserName"
                                                   placeholder="admin">
                                            <small class="form-text text-muted">
                                                Target user account (local part only, no @@domain)
                                            </small>
                                        </td>
                                        <td>
                                            <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-danger" @onclick="() => RemoveAlias(index)">
                                                Remove
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>

                    <button class="btn btn-dashboard btn-dashboard-sm btn-dashboard-info mt-2" @onclick="AddAlias">
                        + Add Alias
                    </button>

                    <div class="alert alert-success mt-3">
                        <strong>How Aliases Work:</strong>
                        <ul class="mb-0">
                            <li>Mail sent to <code>alias@@domain.com</code> is forwarded to <code>user@@domain.com</code></li>
                            <li>Only enter the local part (before @@) in both fields</li>
                            <li>Multiple aliases can point to the same user</li>
                            <li>Aliases are resolved before mail is stored in mailbox</li>
                        </ul>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <strong>Common Standard Aliases:</strong>
                        <p class="mb-2">RFC 5321 requires certain aliases for a compliant mail server:</p>
                        <ul class="mb-0">
                            <li><code>postmaster</code> → Administrator for mail issues (required by RFC 5321)</li>
                            <li><code>abuse</code> → Handling abuse complaints</li>
                            <li><code>hostmaster</code> → DNS and server administration</li>
                            <li><code>webmaster</code> → Website administration</li>
                            <li><code>noc</code> → Network Operations Center</li>
                            <li><code>security</code> → Security-related issues</li>
                        </ul>
                    </div>

                    <div class="border-top pt-3 mt-4">
                        <button class="btn btn-dashboard btn-dashboard-primary btn-dashboard-lg me-2" @onclick="SaveSettings">
                            Save Settings
                        </button>
                        <button class="btn btn-dashboard btn-dashboard-outline btn-dashboard-lg" @onclick="AddStandardAliases">
                            Add Standard Aliases
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void AddAlias()
    {
        settings.SmtpServer.AliasList.Add(new SmtpAliasEntry
        {
            AliasName = "",
            UserName = ""
        });
    }

    private void RemoveAlias(int index)
    {
        if (index >= 0 && index < settings.SmtpServer.AliasList.Count)
        {
            settings.SmtpServer.AliasList.RemoveAt(index);
        }
    }

    private void AddStandardAliases()
    {
        var standardAliases = new Dictionary<string, string>
        {
            { "postmaster", "admin" },
            { "abuse", "admin" },
            { "hostmaster", "admin" },
            { "webmaster", "admin" },
            { "noc", "admin" },
            { "security", "admin" }
        };

        foreach (var (alias, user) in standardAliases)
        {
            if (!settings.SmtpServer.AliasList.Any(a => a.AliasName.Equals(alias, StringComparison.OrdinalIgnoreCase)))
            {
                settings.SmtpServer.AliasList.Add(new SmtpAliasEntry
                {
                    AliasName = alias,
                    UserName = user
                });
            }
        }

        saveMessage = "Standard aliases added. Modify as needed and click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            // Validate alias entries
            var invalidAliases = settings.SmtpServer.AliasList
                .Where(a => string.IsNullOrWhiteSpace(a.AliasName) || string.IsNullOrWhiteSpace(a.UserName))
                .ToList();

            if (invalidAliases.Any())
            {
                saveMessage = "Error: Alias name and user name cannot be empty. Please remove or fill in all entries.";
                saveSuccess = false;
                return;
            }

            // Check for duplicate aliases
            var duplicates = settings.SmtpServer.AliasList
                .GroupBy(a => a.AliasName.ToLower())
                .Where(g => g.Count() > 1)
                .Select(g => g.Key)
                .ToList();

            if (duplicates.Any())
            {
                saveMessage = $"Error: Duplicate alias found: {string.Join(", ", duplicates)}";
                saveSuccess = false;
                return;
            }

            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}
