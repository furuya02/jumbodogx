@page "/settings/smtp/queue"
@rendermode InteractiveServer
@using Jdx.Core.Settings
@using Jdx.WebUI.Services
@inject ISettingsService SettingsService

<PageTitle>SMTP Queue Settings - JumboDogX</PageTitle>

<h1>SMTP - Queue Settings</h1>

@if (saveMessage != null)
{
    <div class="alert @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @saveMessage
        <button type="button" class="btn-close" @onclick="() => saveMessage = null"></button>
    </div>
}

<div class="row">
    <div class="col-md-10">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ðŸ“¬ Mail Queue Configuration</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <strong>Mail Queue:</strong>
                    The queue system manages outgoing mail delivery. Messages are stored in a queue
                    and delivered asynchronously with automatic retry on failure.
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="always"
                               @bind="settings.SmtpServer.Always">
                        <label class="form-check-label" for="always">
                            <strong>Always Use Queue</strong>
                        </label>
                    </div>
                    <div class="form-text">
                        Always queue messages instead of attempting immediate delivery.
                        Useful for unreliable networks or scheduled delivery.
                    </div>
                </div>

                <hr />

                <h6 class="mt-3 mb-3">Queue Processing Settings</h6>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="threadSpan" class="form-label">Queue Check Interval (seconds)</label>
                        <input type="number" class="form-control" id="threadSpan"
                               @bind="settings.SmtpServer.ThreadSpan" min="10" max="3600">
                        <div class="form-text">
                            How often to check the queue for pending messages (default: 300)
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="threadMax" class="form-label">Max Concurrent Threads</label>
                        <input type="number" class="form-control" id="threadMax"
                               @bind="settings.SmtpServer.ThreadMax" min="1" max="20">
                        <div class="form-text">
                            Maximum number of concurrent delivery threads (default: 5)
                        </div>
                    </div>
                </div>

                <hr />

                <h6 class="mt-3 mb-3">Retry Settings</h6>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="retryMax" class="form-label">Maximum Retry Attempts</label>
                        <input type="number" class="form-control" id="retryMax"
                               @bind="settings.SmtpServer.RetryMax" min="0" max="20">
                        <div class="form-text">
                            Number of times to retry failed delivery before giving up (default: 5)
                        </div>
                    </div>
                </div>

                <div class="alert alert-success">
                    <strong>Retry Strategy:</strong>
                    Messages that fail to deliver are automatically retried up to
                    <strong>@settings.SmtpServer.RetryMax times</strong>.
                    Failed messages are checked every <strong>@settings.SmtpServer.ThreadSpan seconds</strong>.
                    After all retries are exhausted, a bounce message is sent to the sender.
                </div>

                <hr />

                <h6 class="mt-3 mb-3">DNS Settings</h6>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="mxOnly"
                                   @bind="settings.SmtpServer.MxOnly">
                            <label class="form-check-label" for="mxOnly">
                                <strong>Use MX Records Only</strong>
                            </label>
                        </div>
                        <div class="form-text">
                            Only use MX (Mail Exchange) records for delivery. If disabled,
                            will fall back to A records if MX lookup fails.
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    @if (settings.SmtpServer.MxOnly)
                    {
                        <text>
                            <strong>MX Only Mode:</strong>
                            The server will strictly use MX records for mail delivery.
                            If no MX record is found, delivery will fail.
                        </text>
                    }
                    else
                    {
                        <text>
                            <strong>MX with A Record Fallback:</strong>
                            The server will try MX records first, then fall back to A records if needed.
                            This is more flexible but less strict with DNS configuration.
                        </text>
                    }
                </div>

                <hr />

                <h6 class="mt-3 mb-3">Performance Recommendations</h6>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">High Volume Server</h6>
                                <p class="card-text">
                                    <strong>Check Interval:</strong> 60 seconds<br />
                                    <strong>Max Threads:</strong> 10<br />
                                    <strong>Max Retries:</strong> 3
                                </p>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SetHighVolume()">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Low Volume Server</h6>
                                <p class="card-text">
                                    <strong>Check Interval:</strong> 300 seconds<br />
                                    <strong>Max Threads:</strong> 5<br />
                                    <strong>Max Retries:</strong> 5
                                </p>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SetLowVolume()">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-top pt-3 mt-4">
                    <button class="btn btn-primary me-2" @onclick="SaveSettings">
                        Save Settings
                    </button>
                    <button class="btn btn-secondary" @onclick="ResetToDefault">
                        Reset to Default
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationSettings settings = new();
    private string? saveMessage;
    private bool saveSuccess;

    protected override void OnInitialized()
    {
        settings = SettingsService.GetSettings();
    }

    private void SetHighVolume()
    {
        settings.SmtpServer.ThreadSpan = 60;
        settings.SmtpServer.ThreadMax = 10;
        settings.SmtpServer.RetryMax = 3;
        saveMessage = "High volume settings applied. Click Save to apply.";
        saveSuccess = true;
    }

    private void SetLowVolume()
    {
        settings.SmtpServer.ThreadSpan = 300;
        settings.SmtpServer.ThreadMax = 5;
        settings.SmtpServer.RetryMax = 5;
        saveMessage = "Low volume settings applied. Click Save to apply.";
        saveSuccess = true;
    }

    private async Task SaveSettings()
    {
        try
        {
            await SettingsService.SaveSettingsAsync(settings);
            saveMessage = "Settings saved successfully!";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"Error saving settings: {ex.Message}";
            saveSuccess = false;
        }

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ResetToDefault()
    {
        var defaults = SettingsService.GetDefaultSettings();
        settings.SmtpServer.Always = defaults.SmtpServer.Always;
        settings.SmtpServer.ThreadSpan = defaults.SmtpServer.ThreadSpan;
        settings.SmtpServer.RetryMax = defaults.SmtpServer.RetryMax;
        settings.SmtpServer.ThreadMax = defaults.SmtpServer.ThreadMax;
        settings.SmtpServer.MxOnly = defaults.SmtpServer.MxOnly;
        saveMessage = "Settings reset to default values. Click Save to apply.";
        saveSuccess = true;
    }
}
