@page "/"
@rendermode InteractiveServer
@using Jdx.WebUI.Services
@using Jdx.Core.Abstractions
@using Jdx.Core.Settings
@inject ServerManager ServerManager
@inject ISettingsService SettingsService
@implements IDisposable

<PageTitle>Dashboard - JumboDogX</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <p class="subtitle">Server management at a glance</p>
    </div>

    <!-- Control Bar -->
    <div class="dashboard-control-bar">
        <span class="control-label">All Servers</span>
        <div class="btn-group">
            <button class="btn btn-dashboard btn-dashboard-success" @onclick="StartAllServers" disabled="@isProcessing">
                Start All
            </button>
            <button class="btn btn-dashboard btn-dashboard-danger" @onclick="StopAllServers" disabled="@isProcessing">
                Stop All
            </button>
            <button class="btn btn-dashboard btn-dashboard-outline" @onclick="RefreshStatus">
                Refresh
            </button>
        </div>
    </div>

    @if (isProcessing)
    {
        <div class="dashboard-alert alert-info mb-4">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Processing...
        </div>
    }

    @if (errorMessage != null)
    {
        <div class="dashboard-alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- HTTP Virtual Hosts -->
    @if (httpServers.Any())
    {
        <h2 class="dashboard-section-title">HTTP/HTTPS Virtual Hosts</h2>
        <div class="row">
            @foreach (var server in httpServers)
            {
                <div class="col-md-6">
                    <div class="server-card">
                        <div class="status-bar @GetStatusBarClass(server.Status)"></div>
                        <div class="card-header-custom d-flex justify-content-between align-items-center">
                            <h5 class="server-name">@server.Name</h5>
                            <span class="status-badge @GetStatusBarClass(server.Status)">@server.Status</span>
                        </div>
                        <div class="card-body-custom">
                            <div class="stat-row">
                                <span class="stat-label">Port</span>
                                <span class="stat-value">@server.Port</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Bind Address</span>
                                <span class="stat-value">@server.BindAddress</span>
                            </div>
                            @if (server.Status == ServerStatus.Running)
                            {
                                var stats = server.GetStatistics();
                                <div class="stat-row">
                                    <span class="stat-label">Connections</span>
                                    <span class="stat-value">@stats.ActiveConnections / @stats.TotalConnections</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Requests</span>
                                    <span class="stat-value">@stats.TotalRequests.ToString("N0")</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Data Sent</span>
                                    <span class="stat-value">@FormatBytes(stats.TotalBytesSent)</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Uptime</span>
                                    <span class="stat-value">@stats.Uptime.ToString(@"hh\:mm\:ss")</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Access URL</span>
                                    <span class="stat-value">
                                        <a href="@GetHttpServerUrl(server)" target="_blank" rel="noopener noreferrer" class="access-link">
                                            @GetHttpServerUrl(server)
                                        </a>
                                    </span>
                                </div>
                            }
                        </div>
                        <div class="card-footer-custom">
                            @if (server.Status == ServerStatus.Running)
                            {
                                <button class="btn btn-dashboard btn-dashboard-danger btn-fullwidth" @onclick="() => StopServer(GetServerId(server))" disabled="@isProcessing">
                                    Stop
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-dashboard btn-dashboard-success btn-fullwidth" @onclick="() => StartServer(GetServerId(server))" disabled="@isProcessing">
                                    Start
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Other Servers -->
    @if (otherServers.Any())
    {
        <h2 class="dashboard-section-title mt-4">Other Servers</h2>
        <div class="row">
            @foreach (var server in otherServers)
            {
                <div class="col-md-6">
                    <div class="server-card">
                        <div class="status-bar @GetStatusBarClass(server.Status)"></div>
                        <div class="card-header-custom d-flex justify-content-between align-items-center">
                            <h5 class="server-name">@server.Name</h5>
                            <span class="status-badge @GetStatusBarClass(server.Status)">@server.Status</span>
                        </div>
                        <div class="card-body-custom">
                            <div class="stat-row">
                                <span class="stat-label">Type</span>
                                <span class="stat-value">@server.Type</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Port</span>
                                <span class="stat-value">@server.Port</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Bind Address</span>
                                <span class="stat-value">@server.BindAddress</span>
                            </div>
                            @if (server.Status == ServerStatus.Running)
                            {
                                var stats = server.GetStatistics();
                                <div class="stat-row">
                                    <span class="stat-label">Connections</span>
                                    <span class="stat-value">@stats.ActiveConnections / @stats.TotalConnections</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Requests</span>
                                    <span class="stat-value">@stats.TotalRequests.ToString("N0")</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Uptime</span>
                                    <span class="stat-value">@stats.Uptime.ToString(@"hh\:mm\:ss")</span>
                                </div>
                            }
                        </div>
                        <div class="card-footer-custom">
                            @if (server.Status == ServerStatus.Running)
                            {
                                <button class="btn btn-dashboard btn-dashboard-danger btn-fullwidth" @onclick="() => StopServer(GetServerId(server))" disabled="@isProcessing">
                                    Stop
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-dashboard btn-dashboard-success btn-fullwidth" @onclick="() => StartServer(GetServerId(server))" disabled="@isProcessing">
                                    Start
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<IServer> servers = new();
    private List<IServer> httpServers = new();
    private List<IServer> otherServers = new();
    private bool isProcessing = false;
    private string? errorMessage;
    private System.Threading.Timer? refreshTimer;

    protected override void OnInitialized()
    {
        LoadServers();
        ServerManager.ServerStateChanged += OnServerStateChanged;

        // 1Áßí„Åî„Å®„Å´Ëá™ÂãïÊõ¥Êñ∞
        refreshTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadServers();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void LoadServers()
    {
        servers = ServerManager.GetAllServers().ToList();
        httpServers = servers.Where(s => s.Type == ServerType.Http).ToList();
        otherServers = servers.Where(s => s.Type != ServerType.Http).ToList();
    }

    private string GetServerId(IServer server)
    {
        return ServerManager.GetServerId(server) ?? server.Name.ToLower();
    }

    private async Task StartServer(string serverId)
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StartServerAsync(serverId);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StopServer(string serverId)
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StopServerAsync(serverId);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StartAllServers()
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StartAllServersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StopAllServers()
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StopAllServersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private void RefreshStatus()
    {
        LoadServers();
    }

    private void OnServerStateChanged(object? sender, ServerEventArgs e)
    {
        InvokeAsync(() =>
        {
            LoadServers();
            StateHasChanged();
        });
    }

    private string GetStatusClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Running => "bg-success text-white",
            ServerStatus.Stopped => "bg-secondary text-white",
            ServerStatus.Starting => "bg-warning",
            ServerStatus.Stopping => "bg-warning",
            ServerStatus.Error => "bg-danger text-white",
            _ => "bg-light"
        };
    }

    private string GetStatusBadgeClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Running => "bg-light text-success",
            ServerStatus.Stopped => "bg-light text-secondary",
            ServerStatus.Starting => "bg-light text-warning",
            ServerStatus.Stopping => "bg-light text-warning",
            ServerStatus.Error => "bg-light text-danger",
            _ => "bg-secondary"
        };
    }

    private string GetStatusBarClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Running => "running",
            ServerStatus.Stopped => "stopped",
            ServerStatus.Starting => "warning",
            ServerStatus.Stopping => "warning",
            ServerStatus.Error => "error",
            _ => "stopped"
        };
    }

    private string GetServerIcon(ServerType type)
    {
        return type switch
        {
            ServerType.Http => "üåê",
            ServerType.Dns => "üì°",
            ServerType.Smtp => "üìß",
            ServerType.Pop3 => "üì¨",
            ServerType.Ftp => "üìÅ",
            ServerType.Dhcp => "üîå",
            _ => "üñ•Ô∏è"
        };
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetHttpServerUrl(IServer server)
    {
        var serverId = GetServerId(server);
        var settings = SettingsService.GetSettings();

        // „Çµ„Éº„Éê„ÉºID„Åã„ÇâVirtualHost„ÇíÁâπÂÆöÔºà‰æã: "http:example.com"Ôºâ
        VirtualHostEntry? vhost = null;
        if (serverId.StartsWith("http:") && settings.HttpServer.VirtualHosts != null)
        {
            var hostName = serverId.Substring(5); // "http:" „ÇíÈô§Âéª
            vhost = settings.HttpServer.VirtualHosts.FirstOrDefault(v => v.Host == hostName);
        }

        // SSLÂà§ÂÆöÔºàVirtualHost„ÅÆË®≠ÂÆö„Åã„ÇâCertificateFile„ÅÆÊúâÁÑ°„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        var useSsl = false;
        if (vhost?.Settings != null)
        {
            useSsl = !string.IsNullOrEmpty(vhost.Settings.CertificateFile);
        }

        // „Éõ„Çπ„ÉàÂêç„ÅÆÊ±∫ÂÆö
        var host = server.BindAddress;
        if (host == "0.0.0.0" || host == "127.0.0.1" || string.IsNullOrEmpty(host))
        {
            host = "localhost";
        }

        var protocol = useSsl ? "https" : "http";
        return $"{protocol}://{host}:{server.Port}/";
    }

    public void Dispose()
    {
        ServerManager.ServerStateChanged -= OnServerStateChanged;
        refreshTimer?.Dispose();
    }
}
