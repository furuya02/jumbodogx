@page "/"
@rendermode InteractiveServer
@using Jdx.WebUI.Services
@using Jdx.Core.Abstractions
@inject ServerManager ServerManager
@implements IDisposable

<PageTitle>Dashboard - JumboDogX</PageTitle>

<h1>Dashboard</h1>

<div class="mb-3">
    <button class="btn btn-success me-2" @onclick="StartAllServers" disabled="@isProcessing">
        ‚ñ∂Ô∏è Start All
    </button>
    <button class="btn btn-danger me-2" @onclick="StopAllServers" disabled="@isProcessing">
        ‚èπÔ∏è Stop All
    </button>
    <button class="btn btn-secondary" @onclick="RefreshStatus">
        üîÑ Refresh
    </button>
</div>

@if (isProcessing)
{
    <div class="alert alert-info">
        <span class="spinner-border spinner-border-sm me-2"></span>
        Processing...
    </div>
}

@if (errorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

<div class="row">
    @foreach (var server in servers)
    {
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header @GetStatusClass(server.Status)">
                    <h5 class="card-title mb-0">
                        @GetServerIcon(server.Type) @server.Name
                        <span class="badge @GetStatusBadgeClass(server.Status) float-end">
                            @server.Status
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Type:</dt>
                        <dd class="col-sm-8">@server.Type</dd>

                        <dt class="col-sm-4">Port:</dt>
                        <dd class="col-sm-8">@server.Port</dd>

                        @if (server.Status == ServerStatus.Running)
                        {
                            var stats = server.GetStatistics();
                            <dt class="col-sm-4">Connections:</dt>
                            <dd class="col-sm-8">@stats.ActiveConnections / @stats.TotalConnections</dd>

                            <dt class="col-sm-4">Requests:</dt>
                            <dd class="col-sm-8">@stats.TotalRequests</dd>

                            <dt class="col-sm-4">Bytes Sent:</dt>
                            <dd class="col-sm-8">@FormatBytes(stats.TotalBytesSent)</dd>

                            <dt class="col-sm-4">Errors:</dt>
                            <dd class="col-sm-8">@stats.TotalErrors</dd>

                            <dt class="col-sm-4">Uptime:</dt>
                            <dd class="col-sm-8">@stats.Uptime.ToString(@"hh\:mm\:ss")</dd>
                        }
                    </dl>
                </div>
                <div class="card-footer">
                    @if (server.Status == ServerStatus.Running)
                    {
                        <button class="btn btn-sm btn-danger" @onclick="() => StopServer(GetServerId(server))" disabled="@isProcessing">
                            ‚èπÔ∏è Stop
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-success" @onclick="() => StartServer(GetServerId(server))" disabled="@isProcessing">
                            ‚ñ∂Ô∏è Start
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<IServer> servers = new();
    private bool isProcessing = false;
    private string? errorMessage;
    private System.Threading.Timer? refreshTimer;

    protected override void OnInitialized()
    {
        LoadServers();
        ServerManager.ServerStateChanged += OnServerStateChanged;

        // 1Áßí„Åî„Å®„Å´Ëá™ÂãïÊõ¥Êñ∞
        refreshTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadServers();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void LoadServers()
    {
        servers = ServerManager.GetAllServers().ToList();
    }

    private string GetServerId(IServer server)
    {
        return ServerManager.GetServerId(server) ?? server.Name.ToLower();
    }

    private async Task StartServer(string serverId)
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StartServerAsync(serverId);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StopServer(string serverId)
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StopServerAsync(serverId);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StartAllServers()
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StartAllServersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private async Task StopAllServers()
    {
        isProcessing = true;
        errorMessage = null;
        try
        {
            await ServerManager.StopAllServersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isProcessing = false;
            LoadServers();
        }
    }

    private void RefreshStatus()
    {
        LoadServers();
    }

    private void OnServerStateChanged(object? sender, ServerEventArgs e)
    {
        InvokeAsync(() =>
        {
            LoadServers();
            StateHasChanged();
        });
    }

    private string GetStatusClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Running => "bg-success text-white",
            ServerStatus.Stopped => "bg-secondary text-white",
            ServerStatus.Starting => "bg-warning",
            ServerStatus.Stopping => "bg-warning",
            ServerStatus.Error => "bg-danger text-white",
            _ => "bg-light"
        };
    }

    private string GetStatusBadgeClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Running => "bg-light text-success",
            ServerStatus.Stopped => "bg-light text-secondary",
            ServerStatus.Starting => "bg-light text-warning",
            ServerStatus.Stopping => "bg-light text-warning",
            ServerStatus.Error => "bg-light text-danger",
            _ => "bg-secondary"
        };
    }

    private string GetServerIcon(ServerType type)
    {
        return type switch
        {
            ServerType.Http => "üåê",
            ServerType.Dns => "üì°",
            ServerType.Smtp => "üìß",
            ServerType.Pop3 => "üì¨",
            ServerType.Ftp => "üìÅ",
            ServerType.Dhcp => "üîå",
            _ => "üñ•Ô∏è"
        };
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    public void Dispose()
    {
        ServerManager.ServerStateChanged -= OnServerStateChanged;
        refreshTimer?.Dispose();
    }
}
